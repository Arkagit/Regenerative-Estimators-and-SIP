set.seed(1234)
library(mcmcse)

source("Data_gen.R")

reps = 100
R = rep(0, reps)
regVAR1 = matrix(0, nrow = reps, ncol = 4)
ess_reg1 = rep(0, reps)




for (k in 1:reps) {
	dat = Gen_data(nsim)
	regens = rbinom(nsim, 1, dat$s)

	regen1e4 = regens[1:1e4]
	regen1e5 = regens[1:1e5]
	regen1e6 = regens[1:1e6]
	regen1e7 = regens[1:1e7]


	# Individual regeneration times
	regen_times_4 = (which(regen1e4 == 1)) - append(c(0), which(regen1e4 == 1)[-length(which(regen1e4 == 1))])
	regen_times_5 = (which(regen1e5 == 1)) - append(c(0), which(regen1e5 == 1)[-length(which(regen1e5 == 1))])
	regen_times_6 = (which(regen1e6 == 1)) - append(c(0), which(regen1e6 == 1)[-length(which(regen1e6 == 1))])
	regen_times_7 = (which(regen1e7 == 1)) - append(c(0), which(regen1e7 == 1)[-length(which(regen1e7 == 1))])


	T4 = append(c(0),which(regen1e4 == 1))
	Z4 = matrix(0, nrow = sum(regen1e4), ncol = 2)

	for(i in 1:(length(T4)-1)){
		for(j in (T4[i] + 1):T4[i+1]){
			Z4[i,1] = Z4[i,1] + dat$x[j]
			Z4[i,2] = Z4[i,2] + dat$y[j]
		}
	}

	T5 = append(c(0),which(regen1e5 == 1))
	Z5 = matrix(0, nrow = sum(regen1e5), ncol = 2)

	for(i in 1:(length(T5)-1)){
		for(j in (T5[i] + 1):T5[i+1]){
			Z5[i,1] = Z5[i,1] + dat$x[j]
			Z5[i,2] = Z5[i,2] + dat$y[j]
		}
	}

	T6 = append(c(0),which(regen1e6 == 1))
	Z6 = matrix(0, nrow = sum(regen1e6), ncol = 2)

	for(i in 1:(length(T6)-1)){
		for(j in (T6[i] + 1):T6[i+1]){
			Z6[i,1] = Z6[i,1] + dat$x[j]
			Z6[i,2] = Z6[i,2] + dat$y[j]
		}
	}

	T7 = append(c(0),which(regen1e7 == 1))
	Z7 = matrix(0, nrow = sum(regen1e7), ncol = 2)

	for(i in 1:(length(T7)-1)){
		for(j in (T7[i] + 1):T7[i+1]){
			Z7[i,1] = Z7[i,1] + dat$x[j]
			Z7[i,2] = Z7[i,2] + dat$y[j]
		}
	}

	dataset = cbind(dat$x, dat$y)

	ess_reg1[k] = multiESS(dataset, covmat = variance(Z7, regen_times_7))

	#dat1e4 = dataset[1:1e4,]
	#dat1e5 = dataset[1:1e5,]
	#dat1e6 = dataset[1:1e6,]
	#dat1e7 = dataset[1:1e7,]

	regVAR1[k,1] = norm(Tr - variance(Z4, regen_times_4), type = "F")
	regVAR1[k,2] = norm(Tr - variance(Z5, regen_times_5), type = "F")
	regVAR1[k,3] = norm(Tr - variance(Z6, regen_times_6), type = "F")
	regVAR1[k,4] = norm(Tr - variance(Z7, regen_times_7), type = "F")

	print(k)
	}

	save("regVAR1" = regVAR1, "ESS_reg1" = ess_reg1, file = "1step.Rdata")
